-- Spring Batch Metadata Tables for Oracle
-- This script creates all required Spring Batch tables
-- Safe to run multiple times - will skip if tables already exist

-- BATCH_JOB_INSTANCE
BEGIN
    EXECUTE IMMEDIATE '
    CREATE TABLE BATCH_JOB_INSTANCE (
        JOB_INSTANCE_ID NUMBER(19,0) PRIMARY KEY,
        VERSION NUMBER(19,0),
        JOB_NAME VARCHAR2(100) NOT NULL,
        JOB_KEY VARCHAR2(32) NOT NULL,
        CONSTRAINT JOB_INST_UN UNIQUE (JOB_NAME, JOB_KEY)
    )';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 THEN NULL; ELSE RAISE; END IF;
END;
/

-- BATCH_JOB_EXECUTION
BEGIN
    EXECUTE IMMEDIATE '
    CREATE TABLE BATCH_JOB_EXECUTION (
        JOB_EXECUTION_ID NUMBER(19,0) PRIMARY KEY,
        VERSION NUMBER(19,0),
        JOB_INSTANCE_ID NUMBER(19,0) NOT NULL,
        CREATE_TIME TIMESTAMP NOT NULL,
        START_TIME TIMESTAMP,
        END_TIME TIMESTAMP,
        STATUS VARCHAR2(10),
        EXIT_CODE VARCHAR2(2500),
        EXIT_MESSAGE VARCHAR2(2500),
        LAST_UPDATED TIMESTAMP,
        CONSTRAINT JOB_INST_EXEC_FK FOREIGN KEY (JOB_INSTANCE_ID) 
            REFERENCES BATCH_JOB_INSTANCE(JOB_INSTANCE_ID)
    )';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 THEN NULL; ELSE RAISE; END IF;
END;
/

-- BATCH_JOB_EXECUTION_PARAMS
BEGIN
    EXECUTE IMMEDIATE '
    CREATE TABLE BATCH_JOB_EXECUTION_PARAMS (
        JOB_EXECUTION_ID NUMBER(19,0) NOT NULL,
        PARAMETER_NAME VARCHAR2(100) NOT NULL,
        PARAMETER_TYPE VARCHAR2(100) NOT NULL,
        PARAMETER_VALUE VARCHAR2(2500),
        IDENTIFYING CHAR(1) NOT NULL,
        CONSTRAINT JOB_EXEC_PARAMS_FK FOREIGN KEY (JOB_EXECUTION_ID)
            REFERENCES BATCH_JOB_EXECUTION(JOB_EXECUTION_ID)
    )';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 THEN NULL; ELSE RAISE; END IF;
END;
/

-- BATCH_STEP_EXECUTION
BEGIN
    EXECUTE IMMEDIATE '
    CREATE TABLE BATCH_STEP_EXECUTION (
        STEP_EXECUTION_ID NUMBER(19,0) PRIMARY KEY,
        VERSION NUMBER(19,0) NOT NULL,
        STEP_NAME VARCHAR2(100) NOT NULL,
        JOB_EXECUTION_ID NUMBER(19,0) NOT NULL,
        CREATE_TIME TIMESTAMP NOT NULL,
        START_TIME TIMESTAMP,
        END_TIME TIMESTAMP,
        STATUS VARCHAR2(10),
        COMMIT_COUNT NUMBER(19,0),
        READ_COUNT NUMBER(19,0),
        FILTER_COUNT NUMBER(19,0),
        WRITE_COUNT NUMBER(19,0),
        READ_SKIP_COUNT NUMBER(19,0),
        WRITE_SKIP_COUNT NUMBER(19,0),
        PROCESS_SKIP_COUNT NUMBER(19,0),
        ROLLBACK_COUNT NUMBER(19,0),
        EXIT_CODE VARCHAR2(2500),
        EXIT_MESSAGE VARCHAR2(2500),
        LAST_UPDATED TIMESTAMP,
        CONSTRAINT JOB_EXEC_STEP_FK FOREIGN KEY (JOB_EXECUTION_ID)
            REFERENCES BATCH_JOB_EXECUTION(JOB_EXECUTION_ID)
    )';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 THEN NULL; ELSE RAISE; END IF;
END;
/

-- BATCH_STEP_EXECUTION_CONTEXT
BEGIN
    EXECUTE IMMEDIATE '
    CREATE TABLE BATCH_STEP_EXECUTION_CONTEXT (
        STEP_EXECUTION_ID NUMBER(19,0) PRIMARY KEY,
        SHORT_CONTEXT VARCHAR2(2500) NOT NULL,
        SERIALIZED_CONTEXT CLOB,
        CONSTRAINT STEP_EXEC_CTX_FK FOREIGN KEY (STEP_EXECUTION_ID)
            REFERENCES BATCH_STEP_EXECUTION(STEP_EXECUTION_ID)
    )';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 THEN NULL; ELSE RAISE; END IF;
END;
/

-- BATCH_JOB_EXECUTION_CONTEXT
BEGIN
    EXECUTE IMMEDIATE '
    CREATE TABLE BATCH_JOB_EXECUTION_CONTEXT (
        JOB_EXECUTION_ID NUMBER(19,0) PRIMARY KEY,
        SHORT_CONTEXT VARCHAR2(2500) NOT NULL,
        SERIALIZED_CONTEXT CLOB,
        CONSTRAINT JOB_EXEC_CTX_FK FOREIGN KEY (JOB_EXECUTION_ID)
            REFERENCES BATCH_JOB_EXECUTION(JOB_EXECUTION_ID)
    )';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 THEN NULL; ELSE RAISE; END IF;
END;
/

-- BATCH_STEP_EXECUTION_SEQ (Sequence for Step Execution IDs)
DECLARE
    seq_count NUMBER;
BEGIN
    SELECT COUNT(*) INTO seq_count FROM user_sequences WHERE sequence_name = 'BATCH_STEP_EXECUTION_SEQ';
    IF seq_count = 0 THEN
        EXECUTE IMMEDIATE 'CREATE SEQUENCE BATCH_STEP_EXECUTION_SEQ START WITH 1 INCREMENT BY 1';
    END IF;
END;
/

-- BATCH_JOB_EXECUTION_SEQ (Sequence for Job Execution IDs)
DECLARE
    seq_count NUMBER;
BEGIN
    SELECT COUNT(*) INTO seq_count FROM user_sequences WHERE sequence_name = 'BATCH_JOB_EXECUTION_SEQ';
    IF seq_count = 0 THEN
        EXECUTE IMMEDIATE 'CREATE SEQUENCE BATCH_JOB_EXECUTION_SEQ START WITH 1 INCREMENT BY 1';
    END IF;
END;
/

-- BATCH_JOB_SEQ (Sequence for Job Instance IDs)
DECLARE
    seq_count NUMBER;
BEGIN
    SELECT COUNT(*) INTO seq_count FROM user_sequences WHERE sequence_name = 'BATCH_JOB_SEQ';
    IF seq_count = 0 THEN
        EXECUTE IMMEDIATE 'CREATE SEQUENCE BATCH_JOB_SEQ START WITH 1 INCREMENT BY 1';
    END IF;
END;
/

-- Create performance indexes
-- These indexes speed up common Spring Batch queries

-- Index on job name and status for finding running/failed jobs
BEGIN
    EXECUTE IMMEDIATE 'CREATE INDEX IDX_JOB_EXEC_STATUS ON BATCH_JOB_EXECUTION(STATUS)';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 THEN NULL; ELSE RAISE; END IF;
END;
/

-- Index on job instance for faster lookups
BEGIN
    EXECUTE IMMEDIATE 'CREATE INDEX IDX_JOB_INST_NAME ON BATCH_JOB_INSTANCE(JOB_NAME)';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 THEN NULL; ELSE RAISE; END IF;
END;
/

-- Index on create time for recent job queries
BEGIN
    EXECUTE IMMEDIATE 'CREATE INDEX IDX_JOB_EXEC_CREATE_TIME ON BATCH_JOB_EXECUTION(CREATE_TIME DESC)';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 THEN NULL; ELSE RAISE; END IF;
END;
/

-- Verify all tables were created
SELECT 'Spring Batch tables created successfully' AS status FROM dual;

-- Show all Spring Batch tables
SELECT table_name FROM user_tables WHERE table_name LIKE 'BATCH%' ORDER BY table_name;

-- Show all Spring Batch indexes
SELECT index_name, table_name FROM user_indexes WHERE table_name LIKE 'BATCH%' ORDER BY table_name, index_name;
